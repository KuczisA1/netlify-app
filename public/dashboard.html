<!DOCTYPE html>
<html lang="pl" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <title>Panel Sterowania</title>

    <link rel="stylesheet" href="assets/dashboard/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script defer src="/assets/js/auth.js"></script>

    <!-- Nadpisania bez zmiany globalnego style.css -->
    <style>
      /* Karta/hero na górze: rośnie z treścią i ma luz na dole */
      header { height: auto !important; min-height: 85vh !important; padding-bottom: 40px !important; }

      /* Siatka z dwoma kolumnami na desktopie */
      .settings-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 18px;
        width: min(1100px, calc(100% - 100px));
        margin: 28px 0 0 50px;
      }
      .settings-grid .text-content { width: 100% !important; margin: 0 !important; }
      .stack > .text-content + .text-content { margin-top: 18px !important; }

      /* Na węższych ekranach: jedna kolumna i wewnętrzne marginesy */
      @media (max-width: 950px) {
        header { width: 95% !important; }
        .settings-grid {
          width: calc(100% - 40px);
          margin: 20px;
          grid-template-columns: 1fr;
          gap: 16px;
        }
      }
      @media (min-width: 951px) {
        .settings-grid { grid-template-columns: 1fr 1fr; align-items: start; }
      }

      /* Prosty wygląd panelu nazwy użytkownika */
      #username-panel {
        padding: 16px;
        border-radius: 14px;
        background: rgba(255,255,255,.85);
        border: 1px solid rgba(0,0,0,.08);
      }
      #username-input {
        display: block;
        width: 100%;
        max-width: 420px;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid rgba(0,0,0,.15);
        background: rgba(255,255,255,.9);
        margin-top: 6px;
      }
      .btn-primary {
        outline: none;
        color: #f2f2f2;
        font-size: 16px;
        font-weight: 500;
        border-radius: 12px;
        padding: 8px 16px;
        border: none;
        cursor: pointer;
        background-image: linear-gradient(135deg,#ff9a9e 10%,#F6416C 100%);
      }

      /* Kafelek z tutorialem (opcjonalnie możesz mieć swoje style) */
      .tutorial-card {
        padding: 16px;
        border-radius: 14px;
        background: rgba(255,255,255,.85);
        border: 1px solid rgba(0,0,0,.08);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .tutorial-card .play {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
      }
      .tutorial-card i { font-size: 18px; }
    </style>
  </head>
  <body>
    <header>
      <nav class="navbar">
        <div class="logo"><a href="/">ChemDisk</a></div>
        <ul class="menu">
          <li><a href="/">Strona Główna</a></li>
          <li><a href="/settings/">Ustawienia Konta</a></li>
        </ul>
        <div class="buttons">
          <input
            type="button"
            value="Wejdź do kursu"
            id="members-link"
            data-href="/members/"
            style="display:none"
          />
          <input type="button" id="logout-link" value="Wyloguj" />
        </div>
      </nav>

      <!-- DWIE KOLUMNY NA DESKTOPIE -->
      <div class="settings-grid">
        <!-- LEWA KOLUMNA -->
        <div class="stack">
          <div class="text-content">
            <h2>Cześć,<br />witaj w naszej aplikacji</h2>
            <p>
              W tym miejscu odbywać się będą płatności za pomocą bundla od
              stripe.com – np. opcje miesięczne, półroczne, roczne itp.
            </p>
          </div>

          <div class="text-content">
            <h1>Witaj, <span class="js-username">—</span></h1>
            <p>Email: <span id="user-email">—</span></p>
            <p>Nazwa użytkownika: <span class="js-username">—</span></p>
            <p>Status: <span id="user-status" class="code">—</span></p>
            <div id="status-hint" class="notice" style="margin-top:6px;"></div>
          </div>
        </div>

        <!-- PRAWA KOLUMNA -->
        <div class="stack">
          <!-- Panel zmiany nazwy użytkownika (na to wskazywał Twój skrypt) -->
          <div id="username-panel" class="text-content" style="display:none;">
            <h2>Twoja nazwa użytkownika</h2>
            <label for="username-input" style="display:block;margin-top:10px;">Zmień nazwę</label>
            <input id="username-input" type="text" placeholder="np. JanKowalski" />
            <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:12px;">
              <input type="button" id="username-save" class="btn-primary" value="Zapisz" />
              <span id="username-msg" class="notice" style="min-height:1.2em;"></span>
            </div>
          </div>

          <!-- Kafelek z „Tutorialem” -->
          <div class="tutorial-card text-content">
            <div>
              <strong>Krótki tutorial</strong>
              <div class="muted">Zobacz, jak szybko zacząć pracę w aplikacji.</div>
            </div>
            <div class="play" onclick="openTutorial()">
              <i class="fas fa-play"></i> <span>Odtwórz</span>
            </div>
          </div>
        </div>
      </div>
      <!-- /settings-grid -->
    </header>

    <script>
      // Prosta nawigacja do tutorialu (podmień ścieżkę na własną lub YT)
      function openTutorial() {
        // np. wewnętrzna strona /tutorial lub osadzony YT
        window.location.href = "/tutorial";
      }

      document.addEventListener("DOMContentLoaded", function () {
        const $ = (id) => document.getElementById(id);
        const hasIdentity = () => typeof window !== "undefined" && !!window.netlifyIdentity;

        // --- „Wejdź do kursu”
        const membersBtn = $("members-link");
        if (membersBtn) {
          membersBtn.addEventListener("click", function () {
            const url = membersBtn.dataset.href || "/members/";
            window.location.href = url;
          });
        }

        // --- Wylogowanie
        const logoutBtn = $("logout-link");
        if (logoutBtn) {
          logoutBtn.addEventListener("click", function (e) {
            e.preventDefault();
            if (hasIdentity()) window.netlifyIdentity.logout();
          });
        }

        // ---- Panel nazwy użytkownika (markup już dodany) ----
        const panel   = $("username-panel");
        const input   = $("username-input");
        const saveBtn = $("username-save");
        const msg     = $("username-msg");

        function setAllUsernames(name) {
          document.querySelectorAll(".js-username").forEach((el) => {
            el.textContent = name || "—";
          });
        }

        function statusFromRoles(roles) {
          if (!Array.isArray(roles)) return "pending";
          if (roles.includes("admin") || roles.includes("active")) return "active";
          if (roles.includes("pending")) return "pending";
          return "pending";
        }

        function preferredUsername(user) {
          const md = (user && user.user_metadata) || {};
          return (
            md.username ||
            md.preferred_username ||
            md.name ||
            md.full_name ||
            (user && user.email ? user.email.split("@")[0] : "")
          );
        }

        async function paint() {
          if (!hasIdentity()) return;
          const user = window.netlifyIdentity.currentUser();

          // Pokaż/ukryj panel i wypełnij dane
          if (panel) panel.style.display = user ? "" : "none";

          if (user) {
            $("user-email") && ( $("user-email").textContent = user.email || "—" );
            setAllUsernames(preferredUsername(user));

            const roles = (user.app_metadata && user.app_metadata.roles) || [];
            const status = statusFromRoles(roles);
            $("user-status") && ( $("user-status").textContent = status );
            $("status-hint") && (
              $("status-hint").textContent =
                status === "active"
                  ? "Masz aktywną rolę. Dostęp do strefy Members jest włączony."
                  : "Status pending – poproś administratora o aktywację konta."
            );

            // Pokaż przycisk „Wejdź do kursu” tylko dla zalogowanych
            if (membersBtn) membersBtn.style.display = "";
          } else {
            $("user-email") && ( $("user-email").textContent = "—" );
            setAllUsernames("—");
            $("user-status") && ( $("user-status").textContent = "—" );
            $("status-hint") && ( $("status-hint").textContent = "" );
            if (membersBtn) membersBtn.style.display = "none";
          }
        }

        // Zapis nazwy do user_metadata.username
        if (saveBtn) {
          saveBtn.addEventListener("click", async function () {
            const user = hasIdentity() && window.netlifyIdentity.currentUser();
            if (!user) { msg && (msg.textContent = "Musisz być zalogowany."); return; }

            const newName = (input && input.value ? input.value.trim() : "");
            if (!newName) { msg && (msg.textContent = "Podaj nazwę użytkownika."); return; }
            if (newName.length < 2 || newName.length > 40) {
              msg && (msg.textContent = "Nazwa powinna mieć 2–40 znaków.");
              return;
            }

            saveBtn.disabled = true;
            msg && (msg.textContent = "Zapisywanie...");
            try {
              await user.update({ data: { username: newName } });
              try { await user.jwt(true); } catch (e) {}
              setAllUsernames(newName);
              msg && (msg.textContent = "Zapisano.");
            } catch (e) {
              msg && (msg.textContent = "Błąd zapisu: " + (e && e.message ? e.message : "spróbuj ponownie"));
            } finally {
              saveBtn.disabled = false;
            }
          });
        }

        // Inicjalizacja i nasłuch Netlify Identity
        if (hasIdentity()) {
          try { window.netlifyIdentity.init(); } catch (e) {}
          window.netlifyIdentity.on("init",  () => paint());
          window.netlifyIdentity.on("login", () => paint());
          window.netlifyIdentity.on("logout", () => location.replace("/"));
        }

        // Pierwsze malowanie (np. po back/forward)
        window.addEventListener("pageshow", () => paint());
        document.addEventListener("visibilitychange", () => {
          if (document.visibilityState === "visible") paint();
        });

        paint();
      });
    </script>
  </body>
</html>
