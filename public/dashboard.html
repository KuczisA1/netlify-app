<!DOCTYPE html>
<!-- Created By CodingLab - www.codinglabweb.com -->
<html lang="pl" dir="ltr">
  <head>
    <meta charset="UTF-8">
    <title> Panel Sterowania </title>

    <link rel="stylesheet" href="assets/dashboard/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script defer src="/assets/js/auth.js"></script>
   </head>
<body>
  <header>
    <nav class="navbar">
      <div class="logo"><a href="/">ChemDisk></a></div>
      <ul class="menu">
        <li><a href="#">przycisk 1</a></li>
        <li><a href="#">przycisk 2 itp.</a></li>
      </ul>
      <div class="buttons">
        <input type="button" value="Wejdź do kursu"id="members-link" data-href="/members/" style="display:none">
        <input type="button" id="logout-link" value="Wyloguj">
      </div>
    </nav>
    <div class="text-content">
      <h2>Cześć,<br>witaj w naszej aplikacji</h2>
      <p>W tym miejscu odbywać się będą płatności za pomocą bundla od stripe.com. opcje np. miesięczne półroczne, roczne itp.</p>
    </div>
    <div class="text-content">
        <h1>Witaj, <span class="js-username">—</span></h1>
        <p>Email: <span id="user-email">—</span></p>
        <p>Nazwa użytkownika: <span class="js-username">—</span></p>
        <p>Status: <span id="user-status" class="code">—</span></p>
        <p><div id="status-hint" class="notice"></div></p>
    </div>
    <div class="play-button">
      <span class="play">Tutorial</span>
      <i class="fas fa-play" onclick="click()"></i>
    </div>
  </header>
</body>
<script>
document.addEventListener('DOMContentLoaded', function () {
  // --- Twój istniejący handler dla przycisku "Wejdź do kursu"
  const membersBtn = document.getElementById('members-link');
  if (membersBtn) {
    membersBtn.addEventListener('click', function () {
      const url = membersBtn.dataset.href || '/members/';
      window.location.href = url;
    });
  }

  // --- Panel zmiany nazwy użytkownika
  const panel   = document.getElementById('username-panel');
  const input   = document.getElementById('username-input');
  const saveBtn = document.getElementById('username-save');
  const msg     = document.getElementById('username-msg');

  function setAllUsernames(name) {
    document.querySelectorAll('.js-username').forEach(el => {
      el.textContent = name || '—';
    });
  }

  function preferredUsername(user) {
    const md = (user && user.user_metadata) || {};
    return md.username ||
           md.preferred_username ||
           md.name ||
           md.full_name ||
           (user && user.email ? user.email.split('@')[0] : '');
  }

  function updateUsernamePanel(user) {
    if (!panel) return;
    if (user) {
      panel.style.display = ''; // pokaż
      // Podstaw wartość w input (jeśli wcześniej była ustawiona w metadata)
      const md = user.user_metadata || {};
      input && (input.value = md.username || md.preferred_username || '');
      // Uzupełnij widoki powitalne
      setAllUsernames(preferredUsername(user));
    } else {
      panel.style.display = 'none'; // ukryj, gdy nie zalogowany
    }
  }

  // Podłącz do Netlify Identity (init/login/logout)
  if (window.netlifyIdentity) {
    window.netlifyIdentity.on('init',   updateUsernamePanel);
    window.netlifyIdentity.on('login',  updateUsernamePanel);
    window.netlifyIdentity.on('logout', updateUsernamePanel);
    // Od razu spróbuj z obecnym stanem
    updateUsernamePanel(window.netlifyIdentity.currentUser());
  }

  // Zapis nowej nazwy do user_metadata.username
  if (saveBtn) {
    saveBtn.addEventListener('click', async function () {
      const user = window.netlifyIdentity && window.netlifyIdentity.currentUser();
      if (!user) { msg && (msg.textContent = 'Musisz być zalogowany.'); return; }

      const newName = (input && input.value ? input.value.trim() : '');
      if (!newName) { msg && (msg.textContent = 'Podaj nazwę użytkownika.'); return; }
      if (newName.length < 2 || newName.length > 40) {
        msg && (msg.textContent = 'Nazwa powinna mieć 2–40 znaków.');
        return;
      }

      saveBtn.disabled = true;
      msg && (msg.textContent = 'Zapisywanie...');

      try {
        await user.update({ data: { username: newName } });
        try { await user.jwt(true); } catch (e) {}

        // Odśwież widoki na stronie
        setAllUsernames(newName);
        msg && (msg.textContent = 'Zapisano.');
      } catch (e) {
        msg && (msg.textContent = 'Błąd zapisu: ' + (e && e.message ? e.message : 'spróbuj ponownie'));
      } finally {
        saveBtn.disabled = false;
      }
    });
  }
});
</script>
</html>