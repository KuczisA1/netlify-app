<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ChemDisk – PDF Viewer</title>

  <meta name="referrer" content="strict-origin-when-cross-origin">
  <meta name="robots" content="noindex, nofollow" />
  <link rel="icon" href="/assets/logo-chemdisk.svg" />

  <style>
    :root{
      --mask-gap: 0px;       /* odsunięcie od prawej krawędzi (zostaw 0) */
      --rail-width: 96px;    /* szerokość pasa maski po prawej */
      --corner-w: 84px;      /* szerokość hitboxa rogu */
      --corner-h: 72px;      /* wysokość hitboxa rogu */
      --corner-gap-x: 12px;  /* odsunięcie rogu od prawej */
      --corner-gap-y: 8px;   /* odsunięcie rogu od góry */
    }

    html, body { height: 100%; margin: 0; background: #0b0b0c; overflow: hidden; }

    /* Iframe z podglądem */
    #pdfFrame{
      position: fixed; inset: 0; width: 100%; height: 100%;
      border: 0; display: none;
      z-index: 1;
      pointer-events: auto !important;
      background: #000;
    }

    /* Overlay z komunikatami (lekki, niczego nie „przycina”) */
    #msg{
      position: fixed; inset: 0; z-index: 2;
      display: grid; place-items: center;
      padding: 24px;
      font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: #eaeaea; text-align: center;
    }
    #msg b{ color:#fff; }
    #msg[hidden]{ display:none !important; }
    .hint{ opacity:.85; font-size:14px; margin-top:.6rem; }

    /* Maska anty-popout: root nie łapie eventów; tylko „hitboxy” je przechwytują */
    #maskRoot{
      position: fixed; inset: 0; z-index: 3;
      pointer-events: none;
    }
    #maskRoot[hidden]{ display:none !important; }
    #maskRoot .hit{
      position: absolute;
      pointer-events: auto;
      background: transparent; /* całkowicie niewidoczne */
      /* Jeśli chcesz lekko zasłonić ikonę, dodaj np.:
      background: linear-gradient(90deg, rgba(11,11,12,.6), rgba(11,11,12,0));
      */
    }
    /* Pionowy pas po prawej – „rail” (domyślny) */
    #maskRoot .rail{
      top: 0;
      right: var(--mask-gap);
      width: var(--rail-width);
      height: 100%;
    }
    /* Mały hitbox w prawym górnym rogu – „corner” */
    #maskRoot .corner{
      top: calc(env(safe-area-inset-top, 0px) + var(--corner-gap-y));
      right: calc(env(safe-area-inset-right, 0px) + var(--corner-gap-x));
      width: var(--corner-w);
      height: var(--corner-h);
    }

    @media (max-width: 640px){
      :root{
        --rail-width: 72px;
        --corner-w: 64px;
        --corner-h: 56px;
      }
    }
  </style>
</head>
<body>
  <iframe id="pdfFrame"
          title="Podgląd PDF (Google Drive)"
          allowfullscreen
          webkitallowfullscreen
          mozallowfullscreen
          referrerpolicy="strict-origin-when-cross-origin"
          sandbox="allow-scripts allow-same-origin allow-forms allow-modals allow-pointer-lock"></iframe>

  <!-- Maska anty-popout (tryb wybierany parametrem ?mask=rail|corner|0) -->
  <div id="maskRoot" hidden aria-hidden="true">
    <div class="hit rail" hidden></div>
    <div class="hit corner" hidden></div>
  </div>

  <div id="msg" hidden></div>

  <script>
    (() => {
      const $ = (id) => document.getElementById(id);
      const showMsg = (text, hint) => {
        const box = $('msg');
        box.innerHTML =
          '<div><b>' + (text || 'Błąd') + '</b>' +
          (hint ? '<div class="hint">' + hint + '</div>' : '') +
          '</div>';
        box.hidden = false;
      };

      // Parametry:
      // ?id=ALIAS [wymagany]
      // ?mode=gview  -> fallback viewer
      // ?mask=rail|corner|0  -> wybór maski (domyślnie: rail)
      const params = new URLSearchParams(location.search);
      const alias = (params.get('id') || '').trim();
      const mode = (params.get('mode') || '').toLowerCase();
      const maskParam = (params.get('mask') || 'rail').toLowerCase();

      if (!alias) {
        showMsg('Brak parametru ?id=ALIAS.',
                'Użyj: /members/modules/pdf/index.html?id=TESTDOC1');
        return;
      }
      if (!/^[A-Za-z0-9_:-]{1,50}$/.test(alias)) {
        showMsg('Nieprawidłowy identyfikator.',
                'Dozwolone znaki: litery, cyfry, _ - :');
        return;
      }

      // Ustaw maskę (lekka, nie wpływa na wydajność)
      const maskRoot = $('maskRoot');
      const maskRail = maskRoot.querySelector('.rail');
      const maskCorner = maskRoot.querySelector('.corner');
      if (maskParam !== '0') {
        maskRoot.hidden = false;
        if (maskParam === 'corner') {
          maskCorner.hidden = false;
        } else {
          maskRail.hidden = false;  // domyślne
        }
      }

      // Pobierz ukryte fileId
      const endpoint = '/.netlify/functions/pdf-key?key=' + encodeURIComponent(alias);
      showMsg('Ładowanie dokumentu…');

      fetch(endpoint, { credentials: 'same-origin' })
        .then(async (r) => {
          let data = null;
          try { data = await r.json(); } catch (_) {}
          if (!r.ok) throw new Error(data?.error || r.statusText || 'Błąd serwera');
          return data;
        })
        .then(({ fileId }) => {
          if (!fileId) throw new Error('Brak ID pliku dla aliasu "' + alias + '".');

          // URL viewer’a
          const useGView = (mode === 'gview');
          const src = useGView
            ? 'https://docs.google.com/gview?embedded=true&url=' +
              encodeURIComponent('https://drive.google.com/uc?export=download&id=' + fileId)
            : 'https://drive.google.com/file/d/' + encodeURIComponent(fileId) + '/preview';

          const frame = $('pdfFrame');
          frame.src = src;

          // Po załadowaniu pokaż iframe i schowaj overlay
          frame.addEventListener('load', () => {
            frame.style.display = 'block';
            $('msg').hidden = true;
          });

          // Minimalna diagnostyka (bez zbędnych timerów)
          const cs = getComputedStyle(frame);
          if (cs.pointerEvents === 'none') frame.style.pointerEvents = 'auto';
        })
        .catch((e) => {
          showMsg('Nie udało się wczytać dokumentu.',
                  (e && e.message ? e.message + '<br>' : '') +
                  'Sprawdź alias oraz zmienną środowiskową <b>PDF_' + alias.toUpperCase() + '</b>. ' +
                  'Możesz też dodać <code>?mode=gview</code>.');
        });
    })();
  </script>
</body>
</html>
