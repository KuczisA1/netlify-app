<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ChemDisk – PDF Viewer</title>

  <!-- by nie wynosić pełnego referrera do zewnętrza -->
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <meta name="robots" content="noindex, nofollow" />

  <link rel="icon" href="/assets/logo-chemdisk.svg" />
  <style>
    /* Pełny ekran, ciemne tło, proste komunikaty błędów */
    html, body { height: 100%; margin: 0; background: #0b0b0c; }
    #pdfFrame { position: fixed; inset: 0; width: 100%; height: 100%; border: 0; display: none; }
    #msg {
      position: fixed; inset: 0; display: grid; place-items: center;
      padding: 24px; font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: #eaeaea; text-align: center;
    }
    #msg b { color: #fff; }
    .hint { opacity: .8; font-size: 14px; margin-top: .5rem; }
  </style>
</head>
<body>
  <iframe id="pdfFrame" allow="fullscreen"></iframe>
  <div id="msg" hidden></div>

  <script>
    (function () {
      const $ = (id) => document.getElementById(id);
      const msg = (text, hint) => {
        const box = $('msg');
        box.innerHTML = '<div><b>' + (text || 'Błąd') + '</b>' + (hint ? '<div class="hint">' + hint + '</div>' : '') + '</div>';
        box.hidden = false;
      };

      const params = new URLSearchParams(location.search);
      const alias = (params.get('id') || '').trim();

      if (!alias) {
        msg('Brak parametru ?id=ALIAS (np. TESTDOC1).',
            'Użyj: /members/modules/pdf/index.html?id=TESTDOC1');
        return;
      }
      if (!/^[A-Za-z0-9_:-]{1,50}$/.test(alias)) {
        msg('Nieprawidłowy identyfikator.', 'Dozwolone znaki: litery, cyfry, _, -, :');
        return;
      }

      fetch('/.netlify/functions/pdf-key?key=' + encodeURIComponent(alias))
        .then(async (r) => {
          let data = null;
          try { data = await r.json(); } catch (_) {}
          if (!r.ok) throw new Error(data?.error || r.statusText || 'Błąd serwera');
          return data;
        })
        .then(({ fileId }) => {
          if (!fileId) throw new Error('Nie znaleziono ID pliku dla aliasu "' + alias + '".');

          // Google Drive preview (własny toolbar do powiększania/przewijania)
          const src = 'https://drive.google.com/file/d/' + encodeURIComponent(fileId) + '/preview';

          const frame = $('pdfFrame');
          frame.src = src;
          frame.style.display = 'block';

          // schowaj komunikat jeśli był
          $('msg').hidden = true;
        })
        .catch((e) => {
          msg('Błąd: ' + (e?.message || 'Nie udało się pobrać ID pliku.'),
              'Sprawdź alias w URL oraz zmienną środowiskową PDF_' + alias.toUpperCase());
        });
    })();
  </script>
</body>
</html>
